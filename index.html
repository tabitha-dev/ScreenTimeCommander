<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Time Commander</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        
        /* CSS Variables for Light/Dark Mode */
        :root {
            --bg-primary: #eef4ff; /* Light sky blue for background */
            --bg-card: #ffffff; /* Pure white for cards */
            --bg-tint: #f0f4f8; /* Soft tint for accordion headers, inputs */
            --text-primary: #1e293b; /* Slate 900 equivalent */
            --text-secondary: #64748b; /* Slate 500 equivalent */
            --border-soft: #d1d5db; /* Gray 300 equivalent for borders */
        }
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-card: #1e293b;
            --bg-tint: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-soft: #374151;
        }

        /* Base Styles using Variables */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }
        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-soft);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        /* Accordion Header uses the tint variable */
        .accordion-header {
            background-color: var(--bg-tint);
        }
        /* Style input/checkbox backgrounds for contrast */
        input[type="number"], .task-checkbox {
            background-color: var(--bg-card);
            border-color: var(--border-soft);
        }
        /* Softer glow for light mode */
        .glow-text {
            text-shadow: 0 0 1px rgba(59, 130, 246, 0.5), 0 0 3px rgba(30, 64, 175, 0.3); 
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--text-secondary); border-radius: 4px; }
        
        /* Progress Ring Styling */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        
        /* Motion Preference */
        @media (prefers-reduced-motion) {
            .transition { transition: none !important; }
            .transform { transform: none !important; }
            .progress-ring__circle { transition: none !important; }
            .button-press:active { transform: none !important; }
        }

        /* Press effect for buttons */
        .button-press:active {
            transform: scale(0.98);
        }
        
        /* Style for Accordion Content */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
        }
        .accordion-content.expanded {
            max-height: 1000px; /* Large enough number */
            padding-top: 0.75rem;
        }
        /* Style for Badge Tooltip */
        .badge-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto">

        <!-- Header and Theme Toggle -->
        <header class="flex justify-between items-start mb-8">
            <div class="text-left">
                <h1 class="text-4xl sm:text-5xl font-extrabold text-blue-500 tracking-tight glow-text">
                    Screen Time Commander
                </h1>
                <p id="reset-date-info" class="text-sm italic text-gray-500 mt-1"></p>
            </div>
            <button id="theme-toggle" aria-label="Toggle light/dark theme" class="card p-3 rounded-full text-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-200 button-press">
                <span id="theme-icon">üîÜ</span>
            </button>
        </header>
        
        <!-- --- Commander Profile Section (New) --- -->
        <section id="profile-section" class="card p-6 rounded-xl shadow-2xl mb-8 flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-8">
            
            <!-- Avatar and Name -->
            <div class="flex items-center space-x-4 flex-shrink-0">
                <div class="w-16 h-16 bg-blue-500 rounded-full border-4 border-yellow-400 flex items-center justify-center text-4xl shadow-lg">
                    üõ°Ô∏è
                </div>
                <div>
                    <p class="text-xs font-medium text-gray-500 dark:text-gray-400">COMMANDER</p>
                    <h2 class="text-2xl font-extrabold text-primary">Mission Agent</h2>
                </div>
            </div>

            <!-- Badges Display -->
            <div id="badge-display" class="flex-grow flex items-center space-x-2 border-t md:border-t-0 md:border-l border-border-soft pt-4 md:pt-0 md:pl-8">
                <span class="text-sm font-semibold text-secondary min-w-[50px]">Badges:</span>
                <!-- Badges rendered here -->
            </div>

            <!-- Progress Summary -->
            <div id="progress-summary" class="text-left md:text-right border-t md:border-t-0 md:border-l border-border-soft pt-4 md:pt-0 md:pl-8 flex-shrink-0">
                <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">Lifetime Progress</p>
                <p class="text-xl font-bold text-green-600 dark:text-green-400">
                    <span id="lifetime-tasks">0</span> Missions
                </p>
                <p class="text-sm text-gray-500 dark:text-gray-400">
                    <span id="lifetime-mins">0</span> Total Mins Earned
                </p>
            </div>
        </section>
        
        <!-- Score Board (Replaced Net Balance with Progress Ring) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            
            <!-- Total Earned Time Card -->
            <div class="card p-6 rounded-xl shadow-lg border-l-4 border-green-500 transform hover:scale-[1.01] transition duration-300">
                <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">Total Earned Time</p>
                <p id="earned-minutes" class="text-4xl font-extrabold mt-1 text-green-600 dark:text-green-400">0</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">minutes available</p>
            </div>
            
            <!-- Total Spent Time Card -->
            <div class="card p-6 rounded-xl shadow-lg border-l-4 border-red-500 transform hover:scale-[1.01] transition duration-300">
                <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">Total Spent Time</p>
                <p id="spent-minutes" class="text-4xl font-extrabold mt-1 text-red-600 dark:text-red-400">0</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">minutes redeemed</p>
            </div>

            <!-- NET Balance Card (Progress Ring) -->
            <div id="net-balance-card" class="card p-6 rounded-xl shadow-lg transform hover:scale-[1.01] transition duration-300 relative flex flex-col items-center justify-center">
                <div class="flex items-center justify-center space-x-2 w-full mb-3">
                    <span id="streak-icon" class="text-2xl">üßä</span>
                    <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">Daily Streak: <span id="streak-count" class="font-extrabold">0</span></p>
                </div>
                
                <!-- Circular Progress Ring (SVG) -->
                <svg id="progress-ring" class="w-32 h-32" viewBox="0 0 100 100">
                    <defs>
                        <linearGradient id="netGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#3b82f6; stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#6366f1; stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="netLowGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#f59e0b; stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#f97316; stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle id="ring-track" class="text-gray-200 dark:text-gray-600" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50"/>
                    <circle id="ring-bar" class="progress-ring__circle" stroke-width="8" stroke="url(#netGradient)" fill="transparent" r="45" cx="50" cy="50" style="stroke-dasharray: 283; stroke-dashoffset: 283;"/>
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center pt-8">
                    <p class="text-2xl font-bold text-gray-500 dark:text-gray-400">BALANCE</p>
                    <p id="net-balance" class="text-5xl font-extrabold text-blue-600 dark:text-blue-400 leading-none mt-1">0</p>
                </div>
            </div>
        </div>

        <!-- Task List Section (with Accordions) -->
        <section id="task-section" class="card p-4 sm:p-6 rounded-xl shadow-2xl mb-8">
            <h2 class="text-2xl font-extrabold text-gray-800 dark:text-gray-200 mb-2 border-b pb-2">Mission Control</h2>
            <div id="task-list" class="space-y-1">
                <!-- Tasks and Accordions will be rendered here -->
            </div>
        </section>

        <!-- Reward Redemption Section -->
        <section class="card p-4 sm:p-6 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-extrabold text-gray-800 dark:text-gray-200 mb-4 border-b pb-2">Redeem Power-Ups</h2>
            <div class="flex flex-col sm:flex-row gap-4">
                
                <input type="number" id="redeem-amount" placeholder="Minutes to redeem (e.g., 30)" 
                       class="flex-grow p-3 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg shadow-inner" 
                       min="1" value="30">
                
                <button id="redeem-xbox" data-activity="Xbox" 
                        class="redeem-btn button-press w-full sm:w-auto p-3 text-lg font-semibold rounded-lg bg-emerald-500 text-white hover:bg-emerald-600 transition duration-150 shadow-md min-w-[44px] min-h-[44px]">
                    Redeem for üéÆ Xbox
                </button>
                
                <button id="redeem-youtube" data-activity="YouTube"
                        class="redeem-btn button-press w-full sm:w-auto p-3 text-lg font-semibold rounded-lg bg-red-500 text-white hover:bg-red-600 transition duration-150 shadow-md min-w-[44px] min-h-[44px]">
                    Redeem for ‚ñ∂Ô∏è YouTube
                </button>
            </div>
            
            <!-- ARIA Live Region for Messages -->
            <div id="message-box-container" role="status" aria-live="polite" class="mt-4 text-center h-6">
                <p id="message-box" class="font-bold transition duration-300"></p>
            </div>
            
            <button id="undo-button" class="hidden w-full mt-2 py-2 px-4 text-sm font-semibold rounded-lg bg-yellow-500 text-white hover:bg-yellow-600 transition duration-150 button-press min-w-[44px] min-h-[44px]">
                UNDO Last Redemption (10s)
            </button>
        </section>

        <!-- Hidden Daily Reset Button / Debug -->
        <div class="text-center mt-6">
            <button id="force-reset" class="text-sm text-gray-500 dark:text-gray-400 hover:text-red-500 transition duration-150 button-press">
                Force Daily Reset (Admin Use)
            </button>
        </div>

    </div>

    <!-- Modal for Confirmation (Dialog Pattern) -->
    <div id="reset-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div role="dialog" aria-modal="true" aria-labelledby="modal-title" tabindex="-1"
             class="card p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Confirm Daily Reset</h3>
            <p class="mb-6 text-gray-700 dark:text-gray-300">Are you sure you want to manually reset the day? This clears all completed tasks and sets earned time to zero.</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-150 button-press min-w-[44px] min-h-[44px]">Cancel</button>
                <button id="modal-reset-confirm" class="py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150 button-press min-w-[44px] min-h-[44px]">Reset Day</button>
            </div>
        </div>
    </div>


    <script>
        // PWA Setup: Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('SW registered: ', registration);
                }).catch(registrationError => {
                    console.log('SW registration failed: ', registrationError);
                });
            });
        }
    </script>
    
    <!-- Inline Service Worker and Manifest for self-contained single file -->
    <script id="pwa-files">
        const MANIFEST_CONTENT = {
            "name": "Screen Time Commander",
            "short_name": "STMission",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#eef4ff", /* Updated to match new light mode background */
            "theme_color": "#3b82f6",
            "icons": [
                { "src": "https://placehold.co/192x192/3b82f6/ffffff?text=STM", "sizes": "192x192", "type": "image/png" },
                { "src": "https://placehold.co/512x512/3b82f6/ffffff?text=STM", "sizes": "512x512", "type": "image/png" }
            ]
        };
        const SERVICE_WORKER_CONTENT = `
            const CACHE_NAME = 'screen-time-v1';
            const urlsToCache = ['/', 'index.html'];

            self.addEventListener('install', event => {
                event.waitUntil(
                    caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
                );
            });

            self.addEventListener('fetch', event => {
                event.respondWith(
                    caches.match(event.request).then(response => response || fetch(event.request))
                );
            });
        `;

        // Create virtual files for PWA setup
        (function setupPWAFiles() {
            const blobManifest = new Blob([JSON.stringify(MANIFEST_CONTENT)], { type: 'application/json' });
            window.URL.createObjectURL(blobManifest); // Not directly used here, but needed in a real GitHub pages setup.
            
            const blobSW = new Blob([SERVICE_WORKER_CONTENT], { type: 'application/javascript' });
            window.URL.createObjectURL(blobSW); // Not directly used here, but needed in a real GitHub pages setup.
            
            // Note: Since this is a single HTML file environment, the Service Worker setup is mostly illustrative.
            // In a real hosting environment (like GitHub Pages), sw.js and manifest.json must be separate files.
        })();
    </script>

    <script>
        // --- Configuration and State ---
        const STORAGE_KEY = 'screenTimeCommanderData';
        const SCHEMA_VERSION = 3; // UPDATED FOR NEW LIFETIME TRACKING
        const UNDO_TIMEOUT_MS = 10000;
        const CIRCLE_RADIUS = 45;
        const CIRCLE_CIRCUMFERENCE = 2 * Math.PI * CIRCLE_RADIUS;

        // Badge Definitions
        const BADGE_DEFINITIONS = [
            { id: 'first_streak', name: '3-Day Commander', description: 'Completed a 3-day perfect task streak.', emoji: 'ü•â' },
            { id: 'kindness_hero', name: 'Kindness Hero', description: 'Completed 5 Kindness Missions.', emoji: '‚ù§Ô∏è' },
            { id: 'master_reader', name: 'Master Reader', description: 'Completed reading missions 10 times.', emoji: 'üìñ' },
        ];

        // Task definitions: points correspond to Screen Time Minutes (STM) earned.
        const TASK_DEFINITIONS = [
            // --- Morning Boost (Total: 30 min) ---
            { id: 'ready', text: 'Gear Up: Get dressed & tidy sleeping area ‚ú®', points: 10, category: 'Morning Boost', icon: '‚ú®', defaultExpanded: true },
            { id: 'bed', text: 'Nest Defense: Make bed neatly üõèÔ∏è', points: 5, category: 'Morning Boost', icon: 'üõèÔ∏è' },
            { id: 'shower_am', text: 'Clean Slate: Shower & brush teeth (AM) ü¶∑', points: 15, category: 'Morning Boost', icon: 'ü¶∑' },
            
            // --- Brain Power (Total: 65 min) ---
            { id: 'read', text: 'Knowledge Scroll: Read for 20 minutes üìö', points: 15, category: 'Brain Power', icon: 'üìö', readingTask: true }, // Flag for badge tracking
            { id: 'portal', text: 'Data Mission: School portal work (15 mins) üíª', points: 15, category: 'Brain Power', icon: 'üíª' },
            { id: 'marathi', text: 'Language Quest: Practice Marathi (20 mins) üáÆüá≥', points: 20, category: 'Brain Power', icon: 'üáÆüá≥' },
            { id: 'coding', text: 'Code Mastery: Practice coding (30 mins) üíæ', points: 15, category: 'Brain Power', icon: 'üíæ' }, 

            // --- Home Hero (Total: 25 min) ---
            { id: 'tidy_area', text: 'Area Sweep: Tidy a main common space üßπ', points: 10, category: 'Home Hero', icon: 'üßπ' },
            { id: 'set_table', text: 'Feast Prep: Set & clear dinner table üçΩÔ∏è', points: 5, category: 'Home Hero', icon: 'üçΩÔ∏è' },
            { id: 'laundry', text: 'Fabric Fold: Help fold one laundry basket üß∫', points: 10, category: 'Home Hero', icon: 'üß∫' },

            // --- Movement & Health (Total: 20 min) ---
            { id: 'play_out', text: 'Energy Burn: Play outside or exercise (45 mins) üèÉ', points: 10, category: 'Movement & Health', icon: 'üèÉ' },
            { id: 'water', text: 'Hydration Check: Drink water with every meal üíß', points: 5, category: 'Movement & Health', icon: 'üíß' },
            { id: 'stretch', text: 'Limb Limber: 10 minutes of stretching üí™', points: 5, category: 'Movement & Health', icon: 'üí™' },

            // --- Kindness & Evening (Total: 25 min) ---
            { id: 'tell_day', text: 'Daily Report: Share one good thing about your day üó£Ô∏è', points: 5, category: 'Kindness & Evening', icon: 'üó£Ô∏è' },
            { id: 'kindness_mission', text: 'Kindness Mission: Help a family member without being asked ‚ù§Ô∏è', points: 5, category: 'Kindness & Evening', icon: '‚ù§Ô∏è', kindnessTask: true }, // Flag for badge tracking
            { id: 'prep_school', text: 'Launch Prep: Pack bag & lay out clothes for tomorrow üéí', points: 10, category: 'Kindness & Evening', icon: 'üéí' },
            { id: 'brush_pm', text: 'Night Clean: Brush teeth (PM) thoroughly üåô', points: 5, category: 'Kindness & Evening', icon: 'üåô' },
            { id: 'plan_tomorrow', text: 'Mission Planning: Plan tomorrow\'s top 3 tasks üìù', points: 5, category: 'Kindness & Evening', icon: 'üìù' },
            
            // --- Life Quests (Non-Screen Rewards) (Total: 20 min) ---
            { id: 'cook_helper', text: 'Chef Squad: Help Dad/Mom prepare dinner for 15 mins üßë‚Äçüç≥', points: 0, category: 'Life Quests', icon: 'üßë‚Äçüç≥', nonScreen: true, reward: 'Choose dinner or dessert tonight' },
            { id: 'social_call', text: 'Socialite: Call/Video Chat a relative for 10 mins üìû', points: 0, category: 'Life Quests', icon: 'üìû', nonScreen: true, reward: 'One hour of family game time' },
        ];
        const MAX_EARNABLE_TIME = TASK_DEFINITIONS.filter(t => !t.nonScreen).reduce((sum, task) => sum + task.points, 0);

        let state = {
            tasks: JSON.parse(JSON.stringify(TASK_DEFINITIONS.map(task => ({
                ...task,
                completed: false
            })))),
            earnedTime: 0,
            spentTime: 0,
            lastResetDate: '', // Will be set to YYYY-MM-DD
            schemaVersion: SCHEMA_VERSION,
            redemptionHistory: [],
            streak: 0,
            theme: 'light', // 'light' or 'dark'
            accordionState: {}, // { categoryName: true/false }
            // NEW LIFETIME TRACKING
            lifetimeMinsEarned: 0,
            lifetimeTasksCompleted: 0,
            badges: [], // Array of awarded badge IDs
            kindnessMissionsCompleted: 0,
            readingDaysCompleted: 0,
        };

        let undoTimeoutId = null;

        // --- DOM Elements (Centralized Access) ---
        const dom = {
            app: document.getElementById('app'),
            taskList: document.getElementById('task-list'),
            earnedMinutes: document.getElementById('earned-minutes'),
            spentMinutes: document.getElementById('spent-minutes'),
            netBalance: document.getElementById('net-balance'),
            resetDateInfo: document.getElementById('reset-date-info'),
            messageBox: document.getElementById('message-box'),
            undoButton: document.getElementById('undo-button'),
            resetModal: document.getElementById('reset-modal'),
            ringBar: document.getElementById('ring-bar'),
            netBalanceCard: document.getElementById('net-balance-card'),
            streakCount: document.getElementById('streak-count'),
            streakIcon: document.getElementById('streak-icon'),
            lifetimeTasks: document.getElementById('lifetime-tasks'),
            lifetimeMins: document.getElementById('lifetime-mins'),
            badgeDisplay: document.getElementById('badge-display'),
        };
        
        // --- Utility Functions ---

        /**
         * Converts a Date object to a YYYY-MM-DD string (ISO format).
         * @param {Date} date 
         * @returns {string}
         */
        function getDateString(date) {
            return date.toISOString().split('T')[0];
        }

        function getTodayDateString() {
            return getDateString(new Date());
        }

        // --- Theme Management ---
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const icon = document.getElementById('theme-icon');
            if (icon) icon.textContent = theme === 'dark' ? 'üåô' : 'üîÜ';
            state.theme = theme;
            saveState();
        }

        function initializeTheme() {
            const storedTheme = localStorage.getItem('themePreference');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            let initialTheme = 'light';
            if (storedTheme) {
                initialTheme = storedTheme;
            } else if (prefersDark) {
                initialTheme = 'dark';
            }
            
            applyTheme(initialTheme);
        }

        // --- State/Storage Management ---

        /**
         * Loads state from localStorage and handles migrations/resets.
         */
        function loadState() {
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                const today = getTodayDateString();
                
                if (storedData) {
                    const loadedState = JSON.parse(storedData);
                    
                    // 1. Schema Migration (handle new V3 structure)
                    if (loadedState.schemaVersion !== SCHEMA_VERSION) {
                        console.log('Migrating data to new schema version:', SCHEMA_VERSION);
                        // Initialize new V3 properties
                        loadedState.schemaVersion = SCHEMA_VERSION;
                        loadedState.lifetimeMinsEarned = loadedState.lifetimeMinsEarned || loadedState.earnedTime || 0;
                        loadedState.lifetimeTasksCompleted = loadedState.lifetimeTasksCompleted || 0;
                        loadedState.badges = loadedState.badges || [];
                        loadedState.kindnessMissionsCompleted = loadedState.kindnessMissionsCompleted || 0;
                        loadedState.readingDaysCompleted = loadedState.readingDaysCompleted || 0;
                        loadedState.accordionState = loadedState.accordionState || {};
                        // Force daily reset on first load after major migration
                        loadedState.lastResetDate = ''; 
                    }

                    // 2. Daily Reset Check (uses YYYY-MM-DD for reliability)
                    if (loadedState.lastResetDate !== today) {
                        const yesterday = getDateString(new Date(Date.now() - 86400000));
                        // Earned for yesterday is calculated from stored tasks, before they are reset
                        const yesterdayTasks = loadedState.tasks || [];
                        const yesterdayEarned = yesterdayTasks.filter(t => t.completed && !t.nonScreen).reduce((sum, task) => sum + task.points, 0);

                        let newStreak = loadedState.streak;
                        if (loadedState.lastResetDate === yesterday && yesterdayEarned === MAX_EARNABLE_TIME) {
                            // Streak continues only if ALL *screen-time earning* tasks were completed yesterday
                            newStreak = Math.min(loadedState.streak + 1, 7); // Cap streak at 7
                            showMessage(`Daily login! Streak ${newStreak > 1 ? 'extended!' : 'started!'}`, 'blue');
                        } else if (loadedState.lastResetDate !== yesterday) {
                            newStreak = 0; // Break streak if not consecutive
                        }

                        performDailyReset(false, newStreak);
                        
                    } else {
                        // Load existing state
                        // Rebuild state.tasks using current TASK_DEFINITIONS to handle updates/deletions
                        const loadedTaskMap = loadedState.tasks.reduce((acc, task) => {
                            acc[task.id] = task.completed;
                            return acc;
                        }, {});

                        state.tasks = TASK_DEFINITIONS.map(definition => ({
                            ...definition,
                            completed: loadedTaskMap[definition.id] || false
                        }));
                        
                        state.earnedTime = loadedState.earnedTime || 0;
                        state.spentTime = loadedState.spentTime || 0;
                        state.lastResetDate = loadedState.lastResetDate;
                        state.streak = loadedState.streak || 0;
                        state.redemptionHistory = loadedState.redemptionHistory || [];
                        state.accordionState = loadedState.accordionState || {};
                        
                        // Load V3 counters
                        state.lifetimeMinsEarned = loadedState.lifetimeMinsEarned || 0;
                        state.lifetimeTasksCompleted = loadedState.lifetimeTasksCompleted || 0;
                        state.badges = loadedState.badges || [];
                        state.kindnessMissionsCompleted = loadedState.kindnessMissionsCompleted || 0;
                        state.readingDaysCompleted = loadedState.readingDaysCompleted || 0;


                        // Check theme preference again
                        const storedThemePreference = localStorage.getItem('themePreference');
                        if (storedThemePreference) {
                            state.theme = storedThemePreference;
                        }
                    }

                } else {
                    // Initial load, set up default state
                    performDailyReset(false, 0);
                }
            } catch (e) {
                console.error("Could not load state:", e);
                // Fallback to default state if loading fails
                performDailyReset(false, 0);
            }
        }

        /**
         * Saves state to localStorage.
         */
        function saveState() {
            try {
                // Only save the necessary data for persistence
                const dataToSave = {
                    tasks: state.tasks.map(task => ({ id: task.id, completed: task.completed, nonScreen: task.nonScreen })), // Include nonScreen flag to determine daily reset earned calc
                    earnedTime: state.earnedTime,
                    spentTime: state.spentTime,
                    lastResetDate: state.lastResetDate,
                    schemaVersion: state.schemaVersion,
                    redemptionHistory: state.redemptionHistory,
                    streak: state.streak,
                    accordionState: state.accordionState,
                    // V3 data
                    lifetimeMinsEarned: state.lifetimeMinsEarned,
                    lifetimeTasksCompleted: state.lifetimeTasksCompleted,
                    badges: state.badges,
                    kindnessMissionsCompleted: state.kindnessMissionsCompleted,
                    readingDaysCompleted: state.readingDaysCompleted,
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                localStorage.setItem('themePreference', state.theme);
            } catch (e) {
                console.error("Could not save state:", e);
            }
        }
        
        /**
         * Performs a daily reset, clearing tasks and setting time to 0.
         * @param {boolean} manual 
         * @param {number} newStreak - The streak to set after reset.
         */
        function performDailyReset(manual = false, newStreak = 0) {
            state.tasks = TASK_DEFINITIONS.map(task => ({
                ...task,
                completed: false
            }));
            
            // Add a completion task bonus for long streaks
            let earnedBonus = 0;
            if (newStreak >= 3) {
                earnedBonus = newStreak * 5; // e.g., 3-day streak = 15 min bonus
                showMessage(`Streak Bonus! +${earnedBonus} minutes for your ${newStreak}-day streak.`, 'green');
            }

            state.earnedTime = earnedBonus;
            state.spentTime = 0;
            state.redemptionHistory = [];
            state.lastResetDate = getTodayDateString();
            state.streak = newStreak;
            
            // Keep accordion state, but collapse if not explicitly marked expanded
            for(const cat in state.accordionState) {
                if (!TASK_DEFINITIONS.find(t => t.category === cat)?.defaultExpanded) {
                    state.accordionState[cat] = false;
                }
            }

            saveState();
            render();
            hideModal();

            if (manual) {
                showMessage(`ADMIN RESET: New missions available.`, 'green');
            }
        }

        /**
         * Checks criteria and awards badges if necessary.
         */
        function checkAndAwardBadges() {
            let awarded = false;

            // 1. 3-Day Commander Badge (Streak)
            if (state.streak >= 3 && !state.badges.includes('first_streak')) {
                state.badges.push('first_streak');
                awarded = true;
                showMessage("Achievement Unlocked: 3-Day Commander! ü•â", 'blue');
            }

            // 2. Kindness Hero (5 Kindness Missions)
            if (state.kindnessMissionsCompleted >= 5 && !state.badges.includes('kindness_hero')) {
                state.badges.push('kindness_hero');
                awarded = true;
                showMessage("Achievement Unlocked: Kindness Hero! ‚ù§Ô∏è", 'blue');
            }
            
            // 3. Master Reader (10 Reading Days)
            if (state.readingDaysCompleted >= 10 && !state.badges.includes('master_reader')) {
                state.badges.push('master_reader');
                awarded = true;
                showMessage("Achievement Unlocked: Master Reader! üìñ", 'blue');
            }
            
            if (awarded) renderProfile(); // Only re-render profile if a badge was given.
        }

        // --- Rendering Functions ---

        /**
         * Renders the entire application state.
         */
        function render() {
            calculateTime();
            updateProgressRing();
            renderScoreBoard();
            renderProfile(); // NEW RENDER FUNCTION
            renderTaskList();
            saveState();
        }

        /**
         * Renders the Commander Profile section.
         */
        function renderProfile() {
            dom.lifetimeTasks.textContent = state.lifetimeTasksCompleted;
            dom.lifetimeMins.textContent = state.lifetimeMinsEarned;

            dom.badgeDisplay.innerHTML = `
                <span class="text-sm font-semibold text-secondary min-w-[50px]">Badges:</span>
                ${BADGE_DEFINITIONS.map(badge => {
                    const isAwarded = state.badges.includes(badge.id);
                    const opacity = isAwarded ? 'opacity-100' : 'opacity-30';
                    const cursor = isAwarded ? 'cursor-pointer' : 'cursor-default';
                    return `
                        <div class="relative group inline-block ${cursor}">
                            <span class="text-3xl transition-opacity duration-300 ${opacity}" 
                                title="${badge.name}: ${badge.description}">
                                ${badge.emoji}
                            </span>
                        </div>
                    `;
                }).join('')}
            `;
            // Re-render task list in case badges changed, which they won't, but good practice.
            renderTaskList(); 
        }

        /**
         * Updates the earned, spent, and net balance display.
         */
        function renderScoreBoard() {
            const netBalance = state.earnedTime - state.spentTime;

            dom.earnedMinutes.textContent = state.earnedTime;
            dom.spentMinutes.textContent = state.spentTime;
            dom.netBalance.textContent = netBalance;
            
            // Set date info
            const todayDate = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            dom.resetDateInfo.textContent = `Tracking for: ${todayDate}`;

            // Update streak display
            dom.streakCount.textContent = state.streak;
            if (state.streak >= 3) {
                dom.streakIcon.textContent = 'üî•'; // Fire
            } else if (state.streak >= 1) {
                dom.streakIcon.textContent = 'üåü'; // Star
            } else {
                dom.streakIcon.textContent = 'üßä'; // Ice (default/break)
            }

            // Update Net Balance Card for low balance
            dom.netBalanceCard.classList.remove('border-l-4', 'border-blue-500', 'border-yellow-500');
            if (netBalance > 0) {
                dom.netBalanceCard.classList.add('border-l-4', 'border-blue-500');
            } else {
                dom.netBalanceCard.classList.add('border-l-4', 'border-yellow-500');
            }
        }

        /**
         * Updates the circular SVG progress ring based on net balance.
         */
        function updateProgressRing() {
            const netBalance = state.earnedTime - state.spentTime;
            // Max time to display progress against is earned time (capped by max earnable)
            const maxForProgress = Math.min(state.earnedTime, MAX_EARNABLE_TIME); 
            
            // Percentage of Earned Time remaining (relative to earned time)
            let percentage = maxForProgress > 0 ? (netBalance / maxForProgress) : 0;
            percentage = Math.max(0, Math.min(1, percentage)); // Clamp between 0 and 1

            // Calculate offset
            const offset = CIRCLE_CIRCUMFERENCE * (1 - percentage);
            
            if (dom.ringBar) {
                dom.ringBar.style.strokeDashoffset = offset;
                
                // Update color based on balance status
                const gradientURL = netBalance >= (MAX_EARNABLE_TIME * 0.25) ? 'url(#netGradient)' : 'url(#netLowGradient)';
                dom.ringBar.setAttribute('stroke', gradientURL);
            }
        }

        /**
         * Renders the dynamic task list with accordions.
         */
        function renderTaskList() {
            dom.taskList.innerHTML = '';
            
            // Group tasks by category
            const categories = state.tasks.reduce((acc, task) => {
                const cat = task.category;
                if (!acc[cat]) {
                    acc[cat] = [];
                }
                acc[cat].push(task);
                return acc;
            }, {});

            for (const category in categories) {
                const tasks = categories[category];
                
                const isExpanded = state.accordionState[category] || tasks.some(t => !t.completed); // Expand if incomplete tasks exist
                state.accordionState[category] = isExpanded; // Ensure state is updated

                // Accordion Header (Button)
                const headerButton = document.createElement('button');
                headerButton.className = 'accordion-header w-full flex justify-between items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition duration-200 button-press min-w-[44px] min-h-[44px]';
                headerButton.setAttribute('data-category', category);
                headerButton.setAttribute('aria-expanded', isExpanded);
                headerButton.innerHTML = `
                    <h3 class="text-lg font-extrabold text-indigo-700 dark:text-indigo-400 uppercase tracking-wider">${category}</h3>
                    <span class="text-xl transform transition-transform duration-300 ${isExpanded ? 'rotate-180' : 'rotate-0'}">
                        ‚¨áÔ∏è
                    </span>
                `;
                dom.taskList.appendChild(headerButton);

                // Accordion Content (Container for tasks)
                const contentDiv = document.createElement('div');
                contentDiv.className = `accordion-content ${isExpanded ? 'expanded' : ''}`;
                contentDiv.setAttribute('data-category-content', category);
                
                tasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    // Add conditional styling for Non-Screen tasks
                    const nonScreenClass = task.nonScreen ? 'border-yellow-400 bg-yellow-50/70 dark:bg-yellow-900/40' : '';
                    const rewardLabel = task.nonScreen ? `Reward: ${task.reward}` : `+${task.points} min`;

                    taskItem.className = `flex items-center justify-between p-3 rounded-lg transition duration-150 border-l-4 bg-card ${
                        task.completed 
                            ? `bg-green-100/70 dark:bg-green-900/40 border-green-500 ${nonScreenClass}`
                            : `${nonScreenClass} hover:bg-gray-50 dark:hover:bg-gray-700 border-transparent`
                    }`;
                    
                    // Use DOM manipulation to create task elements safely
                    const leftContent = document.createElement('div');
                    leftContent.className = 'flex items-center';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `task-${task.id}`;
                    checkbox.checked = task.completed;
                    checkbox.className = 'task-checkbox h-6 w-6 text-indigo-600 dark:text-indigo-400 border-gray-300 dark:border-gray-500 rounded-md focus:ring-indigo-500 cursor-pointer min-w-[44px] min-h-[44px]';
                    checkbox.setAttribute('data-task-id', task.id);

                    const label = document.createElement('label');
                    label.htmlFor = `task-${task.id}`;
                    label.className = `ml-3 text-base font-semibold cursor-pointer ${task.completed ? 'text-gray-500 dark:text-gray-400 line-through' : 'text-gray-800 dark:text-gray-200'}`;
                    label.textContent = task.text; // Use textContent for safety

                    const pointsSpan = document.createElement('span');
                    pointsSpan.className = `text-sm font-extrabold p-1 px-3 rounded-full ${task.completed ? 'bg-green-500 text-white shadow-md' : 'bg-blue-200 text-blue-800 dark:bg-blue-800 dark:text-blue-200'} ${task.nonScreen ? 'bg-yellow-500 text-white' : ''}`;
                    pointsSpan.textContent = rewardLabel;

                    leftContent.appendChild(checkbox);
                    leftContent.appendChild(label);
                    taskItem.appendChild(leftContent);
                    taskItem.appendChild(pointsSpan);

                    contentDiv.appendChild(taskItem);
                });
                dom.taskList.appendChild(contentDiv);
            }
        }

        // --- Logic Functions ---

        /**
         * Calculates total earned time based on completed tasks.
         */
        function calculateTime() {
            state.earnedTime = state.tasks
                .filter(task => task.completed && !task.nonScreen) // Only count screen-time earning tasks
                .reduce((total, task) => total + task.points, 0);
        }

        /**
         * Handles the completion/uncompletion of a task.
         * @param {string} taskId 
         */
        function toggleTaskCompletion(taskId) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                
                // Update Lifetime Counters (V3)
                if (task.completed) {
                    state.lifetimeTasksCompleted += 1;
                    if (!task.nonScreen) {
                        state.lifetimeMinsEarned += task.points;
                    }
                    if (task.kindnessTask) {
                        state.kindnessMissionsCompleted += 1;
                    }
                    if (task.readingTask) {
                        state.readingDaysCompleted += 1;
                    }
                } else {
                    state.lifetimeTasksCompleted -= 1;
                    if (!task.nonScreen) {
                        state.lifetimeMinsEarned -= task.points;
                    }
                    if (task.kindnessTask) {
                        state.kindnessMissionsCompleted -= 1;
                    }
                    if (task.readingTask) {
                        state.readingDaysCompleted -= 1;
                    }
                }

                // Recalculate and re-render
                render();
                checkAndAwardBadges(); // Check for new badges

                // Show message based on action
                if (task.completed) {
                    const rewardMsg = task.nonScreen ? task.reward : `${task.points} minutes!`;
                    showMessage(`Mission Complete! You earned: ${rewardMsg}`, 'green');
                } else {
                    const pointsMsg = task.nonScreen ? `non-screen mission points` : `${task.points} minutes`;
                    showMessage(`Mission Revoked. ${pointsMsg} removed.`, 'red');
                }
            }
        }

        /**
         * Handles the redemption of screen time.
         * @param {string} activity - 'Xbox' or 'YouTube'
         */
        function redeemTime(activity) {
            clearTimeout(undoTimeoutId);
            dom.undoButton.classList.add('hidden');
            
            const inputElement = document.getElementById('redeem-amount');
            const amount = parseInt(inputElement.value, 10);
            const netBalance = state.earnedTime - state.spentTime;
            
            if (isNaN(amount) || amount <= 0) {
                showMessage('Input Error: Please enter 1 minute or more.', 'red');
                return;
            }

            if (amount > netBalance) {
                showMessage(`Insufficient Balance: Only ${netBalance} minutes remain.`, 'red');
                return;
            }

            // Record history and update state
            state.redemptionHistory.push({
                timestamp: new Date().toISOString(),
                activity,
                amount,
                balanceBefore: netBalance
            });
            state.spentTime += amount;
            render();
            
            showMessage(`Success! ${amount} minutes redeemed for ${activity} power-up.`, 'blue');
            inputElement.value = 30; // Reset input

            // Show undo button
            dom.undoButton.classList.remove('hidden');
            undoTimeoutId = setTimeout(() => {
                dom.undoButton.classList.add('hidden');
            }, UNDO_TIMEOUT_MS);
        }
        
        /**
         * Reverts the last redemption from history.
         */
        function undoRedemption() {
            clearTimeout(undoTimeoutId);
            dom.undoButton.classList.add('hidden');
            
            const lastRedemption = state.redemptionHistory.pop();
            
            if (lastRedemption) {
                state.spentTime -= lastRedemption.amount;
                render();
                showMessage(`Undo Successful! ${lastRedemption.amount} minutes restored.`, 'blue');
            } else {
                showMessage('Error: Nothing to undo.', 'red');
            }
        }

        // --- UI/Modal Functions & A11Y ---

        /**
         * Shows a temporary message in the ARIA live region.
         * @param {string} message 
         * @param {string} type - 'green', 'red', or 'blue'
         */
        function showMessage(message, type) {
            dom.messageBox.textContent = message;
            
            // Clear previous color classes
            dom.messageBox.classList.remove('text-red-600', 'text-green-600', 'text-blue-600');
            
            if (type === 'red') dom.messageBox.classList.add('text-red-600');
            if (type === 'green') dom.messageBox.classList.add('text-green-600');
            if (type === 'blue') dom.messageBox.classList.add('text-blue-600');

            // Clear message after 5 seconds
            clearTimeout(window.messageTimeout);
            window.messageTimeout = setTimeout(() => {
                dom.messageBox.textContent = '';
            }, 5000);
        }

        /**
         * Shows the daily reset confirmation modal with focus trap.
         */
        function showResetModal() {
            dom.resetModal.classList.remove('hidden');
            const modalDialog = dom.resetModal.querySelector('[role="dialog"]');
            
            // Set inert on background
            dom.app.setAttribute('inert', '');
            
            // Focus trap setup
            modalDialog.focus();
        }

        /**
         * Hides the modal and removes focus trap.
         */
        function hideModal() {
            dom.resetModal.classList.add('hidden');
            // Remove inert from background
            dom.app.removeAttribute('inert');
            // Return focus to the trigger button (using ID for simplicity)
            document.getElementById('force-reset').focus();
        }

        /**
         * Handles accordion header clicks.
         */
        function toggleAccordion(category) {
            const contentDiv = document.querySelector(`[data-category-content="${category}"]`);
            const headerButton = document.querySelector(`.accordion-header[data-category="${category}"]`);
            
            if (contentDiv && headerButton) {
                const isExpanded = contentDiv.classList.toggle('expanded');
                headerButton.setAttribute('aria-expanded', isExpanded);
                headerButton.querySelector('span').classList.toggle('rotate-180', isExpanded);
                state.accordionState[category] = isExpanded;
                saveState();
            }
        }
        
        // --- Event Listeners Setup (Replaces inline onclick) ---
        function setupEventListeners() {
            // Theme Toggle
            document.getElementById('theme-toggle').addEventListener('click', () => {
                const newTheme = state.theme === 'light' ? 'dark' : 'light';
                applyTheme(newTheme);
            });

            // Task List Delegation (for dynamic checkboxes and accordion headers)
            dom.taskList.addEventListener('click', (e) => {
                if (e.target.classList.contains('task-checkbox')) {
                    toggleTaskCompletion(e.target.dataset.taskId);
                } else {
                    const header = e.target.closest('.accordion-header');
                    if (header) {
                        toggleAccordion(header.dataset.category);
                    }
                }
            });
            
            // Redemption Buttons
            document.querySelectorAll('.redeem-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    redeemTime(e.currentTarget.dataset.activity);
                });
            });

            // Undo Button
            dom.undoButton.addEventListener('click', undoRedemption);

            // Force Reset Button (Show Modal)
            document.getElementById('force-reset').addEventListener('click', showResetModal);

            // Modal Buttons
            document.getElementById('modal-cancel').addEventListener('click', hideModal);
            document.getElementById('modal-reset-confirm').addEventListener('click', () => performDailyReset(true, 0));

            // Modal Background Click (Accessibility: only hide if clicking the backdrop, not the dialog content)
            dom.resetModal.addEventListener('click', (e) => {
                if (e.target === dom.resetModal) {
                    hideModal();
                }
            });
            
            // Modal Focus Trap
            dom.resetModal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideModal();
                    return;
                }
                if (e.key === 'Tab') {
                    const focusableElements = dom.resetModal.querySelectorAll('button');
                    const first = focusableElements[0];
                    const last = focusableElements[focusableElements.length - 1];
                    
                    if (e.shiftKey) { // backwards
                        if (document.activeElement === first) {
                            last.focus();
                            e.preventDefault();
                        }
                    } else { // forwards
                        if (document.activeElement === last) {
                            first.focus();
                            e.preventDefault();
                        }
                    }
                }
            });
        }


        // --- Initialization ---

        window.onload = function() {
            initializeTheme();
            setupEventListeners();
            loadState(); // Load state after setup is complete
            render();
        };

    </script>
</body>
</html>
