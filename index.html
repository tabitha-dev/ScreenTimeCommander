<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Time Commander | Interactive Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- 
        Chosen Palette: Calm Harmony (Light neutrals, blues for accents, green for success, orange for stats)
        Application Structure Plan: The SPA is designed as a single-page, multi-column dashboard. This structure was chosen to provide an immediate, at-a-glance overview of all key information, which is more effective for a task-tracking app than a linear document. The layout is divided into three main thematic zones: 1) A persistent profile/stats column for gamified progress (streaks, badges, LIFETIME PROGRESS). 2) A central column for primary actions (completing missions). 3) A final column for secondary actions and data insights (redeeming rewards, HISTORY LOG, analytics). This task-oriented design allows users to quickly assess their status and perform actions without scrolling, creating a highly usable and efficient experience.
        Visualization & Content Choices: 
        - Report Info: Core stats (Earned/Spent/Balance Time, Streak). Goal: Inform. Viz/Presentation: Large-font KPI Cards. Interaction: Stats dynamically update in real-time as missions are completed or rewards are redeemed. Justification: KPI cards are the clearest way to present single, critical numbers. Library/Method: HTML/JS.
        - Report Info: Daily tasks/missions. Goal: Organize & Interact. Viz/Presentation: Interactive checklists within collapsible accordions. Interaction: Clicking a checkbox marks a mission complete, updates all relevant KPIs, and can unlock badges. Justification: This directly translates the report's task list into an engaging, actionable component. Library/Method: HTML/JS.
        - Report Info: Achievements & Rewards. Goal: Engage & Reward. Viz/Presentation: Badge grid and REWARD HISTORY LOG. Interaction: Rewards trigger a TOAST notification with balance update. Justification: Visual confirmation and history log improve accountability and satisfaction. Library/Method: HTML/JS with Unicode characters.
        - Report Info: Time earned across categories. Goal: Analyze/Compare. Viz/Presentation: A Donut Chart with EMPTY STATE COPY. Interaction: The chart dynamically updates as missions from different categories are completed. Justification: Added empty state handling for improved UX. Library/Method: Chart.js.
        - CONFIRMATION: NO SVG graphics used. NO Mermaid JS used.
    -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        :root {
            /* FIX: Set light mode BG to pure white and TEXT to pure black for guaranteed highest contrast */
            --bg-light: #ffffff; 
            --text-light: #000000; 
            --card-light: #ffffff; 
            --border-light: #e2e8f0; 
            --accent: #3b82f6; /* Base blue accent */
            --green-success: #22c55e; /* Green 500 */
            --red-danger: #ef4444; /* Red 500 */

            --bg-dark: #020617; --text-dark: #e2e8f0; --card-dark: #1e293b; --border-dark: #475569;
            /* New Variable for Title Color */
            --title-blue-light: #1d4ed8; /* Blue 700 */
            --title-blue-dark: #93c5fd; /* Blue 300 */
            /* New Variable for Accordion Header Color */
            --accordion-header-light: #3b82f6; /* Blue 500 */
            --accordion-header-dark: #93c5fd; /* Blue 300 */
        }
        html.light { background-color: var(--bg-light); color: var(--text-light); }
        html.dark { background-color: var(--bg-dark); color: var(--text-dark); }
        
        /* New custom class for main titles */
        .main-title { 
            color: var(--title-blue-light); 
            transition: color 0.3s;
        }
        html.dark .main-title {
            color: var(--title-blue-dark);
        }

        /* New custom class for accordion titles */
        .accordion-title {
            color: var(--accordion-header-light);
            transition: color 0.3s;
        }
        html.dark .accordion-title {
            color: var(--accordion-header-dark);
        }
        
        .card { background-color: var(--card-light); border: 1px solid var(--border-light); transition: background-color 0.3s, border-color 0.3s; }
        html.dark .card { background-color: var(--card-dark); border-color: var(--border-dark); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .accordion-button.open + .accordion-content { max-height: 1000px; }
        
        /* MISSION CHECKBOX STYLING FIX */
        .mission-checkbox {
            color: var(--green-success) !important; /* Set checkmark color */
            border-color: #94a3b8; /* Tailwind slate-400 for neutral border */
        }
        .mission-checkbox:checked {
            background-color: var(--green-success) !important;
            border-color: var(--green-success) !important;
        }

        /* Styling for the completed row text (using dark gray for contrast) */
        .completed-mission-text { 
            text-decoration: line-through; 
            color: #1e293b; /* Dark text for light mode */
        } 
        html.dark .completed-mission-text { 
            color: #94a3b8; /* Light gray text for dark mode */
        }

        .badge { filter: grayscale(1); opacity: 0.5; transform: scale(0.9); transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .badge.unlocked { filter: grayscale(0); opacity: 1; transform: scale(1); }
        .chart-container { position: relative; width: 100%; max-width: 400px; margin-left: auto; margin-right: auto; height: auto; aspect-ratio: 1/1; }
        .chart-line-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 30vh; min-height: 200px; }
        /* Fix for modals to ensure they display correctly */
        .modal { display: none; }
        .modal.flex { display: flex; }

        /* Toast styles for reward confirmation */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .toast {
            animation: fadeIn 0.3s, fadeOut 0.5s 2.5s forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; display: none; }
        }
        /* Empty state chart overlay */
        .chart-empty-state {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body class="antialiased transition-colors duration-300">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="flex justify-between items-center mb-6 sm:mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold main-title">üõ°Ô∏è Screen Time Commander</h1>
            <button id="theme-toggle" class="p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent bg-white dark:bg-slate-700">
                <span class="light-icon">‚òÄÔ∏è</span>
                <span class="dark-icon hidden">üåô</span>
            </button>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 xl:grid-cols-4 gap-6 sm:gap-8">
            
            <section class="lg:col-span-1 xl:col-span-1 space-y-6 sm:space-y-8">
                <div class="card p-5 rounded-2xl shadow-xl">
                    <h2 class="text-xl font-bold mb-4 main-title">Commander Profile</h2>
                    <div class="text-center mb-6">
                        <!-- Neutral icon with BLUE ring accent -->
                        <div class="w-24 h-24 rounded-full bg-slate-100 dark:bg-slate-700 mx-auto flex items-center justify-center text-5xl ring-4 ring-blue-500 dark:ring-blue-700 text-slate-700 dark:text-slate-300">üë§</div>
                        <!-- Editable Commander Name with visual affordance -->
                        <h3 class="mt-4 text-lg font-semibold text-slate-900 dark:text-slate-200">
                            <div class="flex items-center justify-center space-x-2">
                                <span id="commander-name" contenteditable="true" class="hover:bg-slate-200 dark:hover:bg-slate-700 rounded px-1 py-0.5 transition-colors focus:outline-none focus:ring-2 focus:ring-accent inline-block cursor-pointer"></span>
                                <span class="text-sm text-slate-900 dark:text-slate-400">‚úèÔ∏è</span>
                            </div>
                        </h3>
                    </div>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center bg-slate-50 dark:bg-slate-700/50 p-3 rounded-lg">
                            <span class="font-medium text-slate-900 dark:text-slate-300">Current Streak</span>
                            <span id="streak-count" class="font-bold text-lg text-orange-500">0 Days</span>
                        </div>
                         <div class="bg-slate-50 dark:bg-slate-700/50 p-3 rounded-lg">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-medium text-slate-900 dark:text-slate-300">Missions Today</span>
                                <span id="missions-today" class="font-bold text-lg text-green-500">0 / 18</span>
                            </div>
                            <!-- Progress Bar for Missions -->
                            <div class="w-full bg-slate-300 rounded-full h-2.5 dark:bg-slate-600">
                                <div id="mission-progress-bar" class="h-2.5 rounded-full bg-green-500 transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ADDED: Lifetime Stats KPI -->
                <div class="card p-5 rounded-2xl shadow-xl border-t-4 border-blue-500">
                    <h2 class="text-xl font-bold mb-4 main-title">Lifetime Progress</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center text-slate-900 dark:text-slate-300">
                            <span class="font-medium">Total Missions</span>
                            <span id="lifetime-tasks-completed" class="font-bold text-lg text-blue-600">0</span>
                        </div>
                        <div class="flex justify-between items-center text-slate-900 dark:text-slate-300">
                            <span class="font-medium">Total Minutes Earned</span>
                            <span id="lifetime-mins-earned" class="font-bold text-lg text-green-600">0 min</span>
                        </div>
                    </div>
                </div>

                <div class="card p-5 rounded-2xl shadow-xl">
                    <h2 class="text-xl font-bold mb-2 main-title">Achievements</h2>
                     <p class="text-sm text-slate-900 dark:text-slate-400 mb-4">Unlock badges by completing missions and maintaining streaks. This section tracks your accomplishments.</p>
                    <div id="badges-container" class="grid grid-cols-3 gap-4 text-center"></div>
                </div>
            </section>
            
            <section class="lg:col-span-2 xl:col-span-2 space-y-6 sm:space-y-8">
                 <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                     <!-- Earned KPI - Green Border -->
                     <div class="card p-5 rounded-2xl shadow-xl text-center border-green-500 border-2">
                        <h3 class="font-semibold text-slate-900 dark:text-slate-400">‚úÖ Earned Today</h3>
                        <p id="earned-time" class="text-4xl font-bold text-green-600 mt-2">0</p>
                        <p class="text-sm text-slate-900 dark:text-slate-400">minutes</p>
                    </div>
                    <!-- Spent KPI - Red Border -->
                    <div class="card p-5 rounded-2xl shadow-xl text-center border-red-500 border-2">
                        <h3 class="font-semibold text-slate-900 dark:text-slate-400">üî• Spent Today</h3>
                        <p id="spent-time" class="text-4xl font-bold text-red-600 mt-2">0</p>
                        <p class="text-sm text-slate-900 dark:text-slate-400">minutes</p>
                    </div>
                    <!-- Balance KPI - Blue Border -->
                    <div class="card p-5 rounded-2xl shadow-xl text-center border-blue-500 border-2">
                        <h3 class="font-semibold text-slate-900 dark:text-slate-400">üè¶ Balance</h3>
                        <p id="balance-time" class="text-4xl font-bold text-blue-600 mt-2">0</p>
                        <p class="text-sm text-slate-900 dark:text-slate-400">minutes</p>
                    </div>
                </div>

                <div id="mission-control" class="card rounded-2xl shadow-xl">
                     <div class="p-5 border-b border-border-light dark:border-border-dark">
                        <h2 class="text-xl font-bold main-title">Mission Control</h2>
                        <p class="text-sm text-slate-900 dark:text-slate-400 mt-1">Complete your daily missions to earn screen time. Each task helps build good habits and contributes to your daily goals.</p>
                     </div>
                    <div id="missions-list" class="p-5 space-y-2"></div>
                </div>
                
                <div class="card rounded-2xl shadow-xl p-5">
                    <h2 class="text-xl font-bold mb-2 main-title">Streak History</h2>
                    <!-- Dynamic streak info element -->
                    <p id="streak-info" class="text-sm text-slate-900 dark:text-slate-400 mb-4">View your daily mission completion over the last 7 days.</p>
                    <div class="chart-line-container">
                        <canvas id="streakHistoryChart"></canvas>
                    </div>
                </div>
            </section>

            <section class="lg:col-span-3 xl:col-span-1 space-y-6 sm:space-y-8">
                <div id="redeem-powerups" class="card rounded-2xl shadow-xl">
                    <div class="p-5 border-b border-border-light dark:border-border-dark">
                        <h2 class="text-xl font-bold main-title">Redeem Power-Ups</h2>
                        <p class="text-sm text-slate-900 dark:text-slate-400 mt-1">Use your earned minutes to activate rewards.</p>
                    </div>
                    <div id="redeem-list" class="p-5 grid grid-cols-1 gap-4"></div>
                    <!-- ADDED: Reward History Log Section -->
                    <div class="p-5 pt-0">
                        <h3 class="text-lg font-bold mt-4 mb-2 text-slate-900 dark:text-slate-300">Reward History</h3>
                        <ul id="reward-history" class="text-sm space-y-1 text-slate-900 dark:text-slate-400">
                             <li class="text-slate-500 italic">No rewards redeemed yet today.</li>
                        </ul>
                    </div>
                </div>
                <div class="card rounded-2xl shadow-xl p-5">
                    <h2 class="text-xl font-bold mb-2 main-title">Daily Analytics</h2>
                    <p class="text-sm text-slate-900 dark:text-slate-400 mb-4">See where your minutes were earned today.</p>
                    <div class="chart-container">
                        <canvas id="earnedMinutesChart"></canvas>
                        <!-- ADDED: Empty State Overlay -->
                        <div id="minutes-chart-empty" class="chart-empty-state text-slate-500 dark:text-slate-500 font-semibold hidden">
                            Complete any mission to see your progress!
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <button id="reset-day" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 shadow-lg">Reset Day</button>
                 </div>
            </section>
        </main>
    </div>

    <!-- ADDED: Toast Notification Container for success feedback -->
    <div id="toast-container"></div>

    <!-- Modals -->
    <div id="reset-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50">
        <div class="card rounded-2xl shadow-lg p-8 max-w-sm w-full">
            <h2 class="text-xl font-bold mb-4 main-title">Confirm Daily Reset</h2>
            <p class="text-slate-900 dark:text-slate-300 mb-6">This will clear today's progress and earned minutes. Your streak will be reset to zero. Are you sure?</p>
            <div class="flex justify-end gap-4">
                <button id="cancel-reset" class="bg-slate-200 dark:bg-slate-600 font-semibold px-4 py-2 rounded-lg">Cancel</button>
                <button id="confirm-reset" class="bg-red-600 text-white font-semibold px-4 py-2 rounded-lg">Confirm</button>
            </div>
        </div>
    </div>
    
    <div id="error-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50">
        <div class="card rounded-2xl shadow-lg p-8 max-w-sm w-full border-t-4 border-red-500">
            <h2 class="text-xl font-bold mb-4 text-red-600 dark:text-red-400">‚ö†Ô∏è Insufficient Funds</h2>
            <p id="error-message" class="text-slate-900 dark:text-slate-300 mb-6">You need to earn more minutes before redeeming this reward.</p>
            <div class="flex justify-end gap-4">
                <button id="close-error" class="bg-red-500 text-white font-semibold px-4 py-2 rounded-lg">Got It</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const app = {
            state: {},
            minutesChartInstance: null,
            streakChartInstance: null,
            
            missions: [
                { id: 'morning-boost', name: 'Morning Boost', open: true, tasks: [
                    { id: 'gear-up', name: 'Gear Up: Get dressed & tidy sleeping area ‚ú®', time: 10, completed: false },
                    { id: 'make-bed', name: 'Nest Defense: Make bed neatly üõèÔ∏è', time: 5, completed: false },
                    { id: 'clean-slate', name: 'Clean Slate: Shower & brush teeth (AM) ü¶∑', time: 15, completed: false },
                ]},
                { id: 'brain-power', name: 'Brain Power', open: false, tasks: [
                    // FIX: Changed time to 20 min to match title
                    { id: 'read20', name: 'Knowledge Scroll: Read for 20 minutes üìö', time: 20, completed: false, type: 'reading' },
                    { id: 'school-portal', name: 'Data Mission: School portal work (15 mins) üíª', time: 15, completed: false },
                    { id: 'marathi', name: 'Language Quest: Practice Marathi (20 mins) üáÆüá≥', time: 20, completed: false },
                    // FIX: Changed time to 30 min to match title
                    { id: 'code-mastery', name: 'Code Mastery: Practice coding (30 mins) üíæ', time: 30, completed: false },
                ]},
                { id: 'home-hero', name: 'Home Hero', open: false, tasks: [
                    { id: 'area-sweep', name: 'Area Sweep: Tidy a main common space üßπ', time: 10, completed: false },
                    { id: 'feast-prep', name: 'Feast Prep: Set & clear dinner table üçΩÔ∏è', time: 5, completed: false },
                    { id: 'fabric-fold', name: 'Fabric Fold: Help fold one laundry basket üß∫', time: 10, completed: false },
                ]},
                { id: 'movement-health', name: 'Movement & Health', open: false, tasks: [
                    // FIX: Changed time to 45 min to match title
                    { id: 'energy-burn', name: 'Energy Burn: Play outside or exercise (45 mins) üèÉ', time: 45, completed: false },
                    { id: 'hydration-check', name: 'Hydration Check: Drink water with every meal üíß', time: 5, completed: false },
                    { id: 'limb-limber', name: 'Limb Limber: 10 minutes of stretching üí™', time: 5, completed: false },
                ]},
                { id: 'kindness-evening', name: 'Kindness & Evening', open: false, tasks: [
                    { id: 'daily-report', name: 'Daily Report: Share one good thing about your day üó£Ô∏è', time: 5, completed: false },
                    { id: 'kindness-mission', name: 'Kindness Mission: Help a family member without being asked ‚ù§Ô∏è', time: 5, completed: false, type: 'kindness' },
                    { id: 'launch-prep', name: 'Launch Prep: Pack bag & lay out clothes for tomorrow üéí', time: 10, completed: false },
                    { id: 'night-clean', name: 'Night Clean: Brush teeth (PM) thoroughly üåô', time: 5, completed: false },
                    { id: 'mission-plan', name: 'Mission Planning: Plan tomorrow\'s top 3 tasks üìù', time: 5, completed: false },
                ]},
                { id: 'life-quests', name: 'Life Quests', open: false, tasks: [
                    // These tasks have non-minute rewards but are assigned 5 minutes for core balance tracking
                    { id: 'chef-squad', name: 'Chef Squad: Help Dad/Mom prepare dinner for 15 mins üßë‚Äçüç≥ Reward: Choose dinner or dessert tonight', time: 5, completed: false },
                    { id: 'socialite', name: 'Socialite: Call/Video Chat a relative for 10 mins üìû Reward: One hour of family game time', time: 5, completed: false },
                ]}
            ],

            rewards: [
                { id: 'xbox', name: 'Xbox Time', cost: 30 },
                { id: 'youtube', name: 'YouTube Time', cost: 15 }
            ],

            badges: [
                { id: 'streak3', name: '3-Day Commander', emoji: 'ü•â', unlocked: false, condition: s => s.streak >= 3 },
                { id: 'streak7', name: '7-Day Captain', emoji: 'ü•à', unlocked: false, condition: s => s.streak >= 7 },
                { id: 'perfect', name: 'Perfect Day', emoji: 'üåü', unlocked: false, condition: s => s.tasks.every(t => t.completed) },
                { id: 'kindnessHero', name: 'Kindness Hero', emoji: 'üíñ', unlocked: false, condition: s => s.kindnessMissionsCompleted >= 5 },
                { id: 'reader', name: 'Bookworm', emoji: 'üìö', unlocked: false, condition: s => s.readingDaysCompleted >= 5 },
                { id: 'master', name: 'Master Commander', emoji: 'üèÜ', unlocked: false, condition: s => s.lifetimeTasksCompleted >= 100 },
            ],

            init() {
                this.loadState();
                this.bindEvents();
                this.render();
                this.checkDailyReset();
                this.updateModalDisplay();
            },

            get todayDateString() { return new Date().toISOString().split('T')[0]; },

            updateModalDisplay() {
                // Ensure modals start hidden but are ready to be flexed when needed
                document.getElementById('reset-modal').classList.add('modal');
                document.getElementById('error-modal').classList.add('modal');
            },

            loadState() {
                const savedState = localStorage.getItem('screenTimeCommanderStateV2');
                const allTaskIds = this.missions.flatMap(m => m.tasks.map(t => t.id));
                const defaultState = {
                    commanderName: '', 
                    tasks: this.missions.flatMap(m => m.tasks.map(t => ({...t}))),
                    earnedTime: 0, spentTime: 0, streak: 0,
                    badges: this.badges.map(b => ({ id: b.id, unlocked: b.unlocked })),
                    lifetimeMinsEarned: 0, lifetimeTasksCompleted: 0, kindnessMissionsCompleted: 0, readingDaysCompleted: 0,
                    accordionState: this.missions.reduce((acc, m) => ({ ...acc, [m.id]: m.open }), {}),
                    lastResetDate: this.todayDateString,
                    theme: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light',
                    completionHistory: [0, 0, 0, 0, 0, 0, 0], 
                    rewardHistory: [] // ADDED: Initialize reward history
                };
                
                this.state = savedState ? JSON.parse(savedState) : defaultState;
                if (!this.state.completionHistory) this.state.completionHistory = defaultState.completionHistory;
                if (this.state.commanderName === undefined) this.state.commanderName = defaultState.commanderName; 
                if (!this.state.rewardHistory) this.state.rewardHistory = defaultState.rewardHistory; // ADDED: Handle upgrade
                
                const savedTaskIds = new Set(this.state.tasks.map(t => t.id));
                // If the number of missions changes, reset the task list to the new default
                if (allTaskIds.length !== savedTaskIds.size || !allTaskIds.every(id => savedTaskIds.has(id))) {
                    this.state.tasks = defaultState.tasks;
                }

                document.documentElement.className = this.state.theme;
            },

            saveState() { localStorage.setItem('screenTimeCommanderStateV2', JSON.stringify(this.state)); },
            
            checkDailyReset() {
                if (this.state.lastResetDate !== this.todayDateString) {
                    const allTasksCompleted = this.state.tasks.every(t => t.completed);
                    
                    this.state.completionHistory.shift(); 
                    this.state.completionHistory.push(allTasksCompleted ? 1 : 0); 
                    
                    if (allTasksCompleted) {
                        this.state.streak++;
                        const readTaskCompleted = this.state.tasks.find(t => t.type === 'reading' && t.completed);
                        if (readTaskCompleted) this.state.readingDaysCompleted++;
                    } else {
                        this.state.streak = 0;
                    }
                    this.resetDay(false);
                }
            },
            
            resetDay(isManual = true) {
                if (isManual) { 
                    this.state.streak = 0; 
                    this.state.completionHistory.pop();
                    this.state.completionHistory.push(0);
                }
                this.state.earnedTime = 0;
                this.state.spentTime = 0;
                this.state.tasks.forEach(t => t.completed = false);
                this.state.rewardHistory = []; // ADDED: Clear daily reward history
                this.state.lastResetDate = this.todayDateString;
                this.updateBadges();
                this.saveState();
                this.render();
            },

            updateTask(taskId, completed) {
                const task = this.state.tasks.find(t => t.id === taskId);
                if (!task || task.completed === completed) return;

                task.completed = completed;
                const missionTask = this.missions.flatMap(m => m.tasks).find(t => t.id === taskId);
                const timeChange = missionTask.time * (completed ? 1 : -1);

                this.state.earnedTime += timeChange;
                this.state.lifetimeMinsEarned += timeChange;
                this.state.lifetimeTasksCompleted += (completed ? 1 : -1);
                
                if(completed && missionTask.type === 'kindness') this.state.kindnessMissionsCompleted++;
                if(!completed && missionTask.type === 'kindness') this.state.kindnessMissionsCompleted--;
                
                this.updateBadges();
                this.saveState();
                this.render();
            },

            showError(message) {
                document.getElementById('error-message').textContent = message;
                document.getElementById('error-modal').classList.add('flex');
            },
            
            hideError() {
                 document.getElementById('error-modal').classList.remove('flex');
            },
            
            // ADDED: Reward Toast Logic
            showRedemptionSuccess(rewardName, cost, newBalance) {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = 'toast bg-green-500 text-white p-4 rounded-lg shadow-xl mb-3 flex items-center space-x-2';
                toast.innerHTML = `
                    <span class="text-xl">üéâ</span>
                    <span class="font-semibold">Redeemed: ${rewardName} for ${cost} min. Balance: ${newBalance} min.</span>
                `;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.remove(), 3500);
            },

            redeemReward(rewardCost) {
                const balance = this.state.earnedTime - this.state.spentTime;
                if (balance >= rewardCost) {
                    const reward = this.rewards.find(r => r.cost === rewardCost);
                    
                    this.state.spentTime += rewardCost;
                    
                    // ADDED: Log reward history
                    this.state.rewardHistory.push({
                        name: reward.name,
                        cost: rewardCost,
                        timestamp: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                    });
                    
                    this.saveState();
                    this.render();
                    this.showRedemptionSuccess(reward.name, rewardCost, balance - rewardCost); // ADDED: Show visual feedback
                } else {
                    this.showError(`You need ${rewardCost - balance} more minutes to redeem this reward.`);
                }
            },

            updateBadges() {
                // FIX: Corrected variable access bug (used badgeState.id instead of badgeDef.id)
                this.state.badges.forEach(badgeState => {
                    const badgeDef = this.badges.find(b => b.id === badgeState.id);
                    if (badgeDef) {
                        badgeState.unlocked = badgeDef.condition(this.state);
                    }
                });
            },

            toggleAccordion(missionId) {
                this.state.accordionState[missionId] = !this.state.accordionState[missionId];
                this.saveState();
                this.renderMissions();
            },

            toggleTheme() {
                this.state.theme = this.state.theme === 'light' ? 'dark' : 'light';
                document.documentElement.className = this.state.theme;
                this.saveState();
                this.renderThemeToggle();
                this.renderCharts(); // Re-render charts to pick up new theme colors
            },

            bindEvents() {
                document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());
                
                document.getElementById('commander-name').addEventListener('blur', e => {
                    // FIX: Name Guarding (strip HTML tags and limit length)
                    let newName = e.target.textContent.trim();
                    // Simple HTML strip using DOM element for safety
                    const tempDiv = document.createElement('div');
                    tempDiv.textContent = newName;
                    const cleanName = tempDiv.innerHTML.substring(0, 20); // Cap at 20 characters
                    
                    this.state.commanderName = cleanName || '';
                    e.target.textContent = cleanName || 'Enter Name'; // Update display instantly
                    this.saveState();
                    this.renderStats();
                });

                document.getElementById('missions-list').addEventListener('change', e => {
                    if (e.target.type === 'checkbox') this.updateTask(e.target.dataset.taskId, e.target.checked);
                });
                document.getElementById('missions-list').addEventListener('click', e => {
                    const button = e.target.closest('.accordion-button');
                    if (button) this.toggleAccordion(button.dataset.missionId);
                });
                document.getElementById('redeem-list').addEventListener('click', e => {
                    const button = e.target.closest('button');
                    if (button) this.redeemReward(parseInt(button.dataset.cost));
                });
                
                const resetModal = document.getElementById('reset-modal');
                document.getElementById('reset-day').addEventListener('click', () => resetModal.classList.add('flex'));
                document.getElementById('cancel-reset').addEventListener('click', () => resetModal.classList.remove('flex'));
                document.getElementById('confirm-reset').addEventListener('click', () => {
                    this.resetDay(true);
                    resetModal.classList.remove('flex');
                });
                
                document.getElementById('close-error').addEventListener('click', () => this.hideError());
            },
            
            render() {
                this.renderStats();
                this.renderMissions();
                this.renderRewards();
                this.renderBadges(); // Ensures achievements update their unlocked status and appearance
                this.renderThemeToggle();
                this.renderCharts();
                this.renderStreakInfo(); 
                this.renderRewardHistory(); // ADDED: Render history
            },

            renderStats() {
                const balance = this.state.earnedTime - this.state.spentTime;
                // FIX: If name is blank, show the prompt
                document.getElementById('commander-name').textContent = this.state.commanderName || 'Enter Name';
                document.getElementById('earned-time').textContent = this.state.earnedTime;
                document.getElementById('spent-time').textContent = this.state.spentTime;
                document.getElementById('balance-time').textContent = balance;
                document.getElementById('streak-count').textContent = `${this.state.streak} Days`;
                
                const completedCount = this.state.tasks.filter(t => t.completed).length;
                const totalCount = this.state.tasks.length;
                const progressPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                
                document.getElementById('missions-today').textContent = `${completedCount} / ${totalCount}`;
                document.getElementById('mission-progress-bar').style.width = `${progressPercent}%`;

                // ADDED: Lifetime stats rendering
                document.getElementById('lifetime-tasks-completed').textContent = this.state.lifetimeTasksCompleted;
                document.getElementById('lifetime-mins-earned').textContent = `${this.state.lifetimeMinsEarned} min`;
            },

            renderMissions() {
                const container = document.getElementById('missions-list');
                container.innerHTML = this.missions.map(mission => {
                    const isOpen = this.state.accordionState[mission.id];
                    return `
                        <div class="border border-border-light dark:border-border-dark rounded-xl overflow-hidden">
                            <button class="accordion-button w-full flex justify-between items-center p-4 text-left font-semibold ${isOpen ? 'open' : ''}" data-mission-id="${mission.id}">
                                <!-- ACCORDION TITLE COLOR FIX -->
                                <span class="accordion-title">${mission.name}</span>
                                <span class="transform transition-transform ${isOpen ? 'rotate-180' : ''}">‚ñº</span>
                            </button>
                            <div class="accordion-content bg-slate-50 dark:bg-slate-900/50">
                                <div class="p-4 space-y-3">
                                    ${mission.tasks.map(taskDef => {
                                        const taskState = this.state.tasks.find(t => t.id === taskDef.id);
                                        const isCompleted = taskState.completed;
                                        
                                        // Determine if the reward is a time reward or a special reward based on the presence of a reward description
                                        const isSpecialReward = taskDef.name.includes("Reward:");
                                        
                                        // Find the split point to separate mission title from reward text
                                        let missionTitle = taskDef.name;
                                        let rewardDetail = `+${taskDef.time} min`;

                                        if (isSpecialReward) {
                                            const parts = taskDef.name.split(' Reward:');
                                            missionTitle = parts[0].trim();
                                            rewardDetail = `Reward: ${parts[1].trim()}`;
                                        }

                                        // Apply conditional row highlight and text styling
                                        const rowClass = isCompleted 
                                            ? 'bg-green-50 dark:bg-green-900/20' 
                                            : 'hover:bg-slate-100 dark:hover:bg-slate-800';
                                        const textClass = isCompleted 
                                            ? 'completed-mission-text' 
                                            : 'text-slate-900 dark:text-slate-300';
                                        
                                        // Reward detail uses green for positive time values
                                        const rewardDetailClass = isCompleted 
                                            ? 'text-green-600 dark:text-green-400' 
                                            : 'text-blue-600 dark:text-blue-400';
                                        
                                        return `
                                            <div class="flex items-center transition-colors duration-200 p-2 rounded-lg ${rowClass}">
                                                <input type="checkbox" id="task-${taskState.id}" data-task-id="${taskState.id}" 
                                                    class="mission-checkbox h-5 w-5 rounded border-gray-300 focus:ring-green-500 mr-3" 
                                                    ${isCompleted ? 'checked' : ''}>
                                                
                                                <label for="task-${taskState.id}" class="flex-grow ${textClass} transition-colors">
                                                    ${missionTitle} 
                                                    <span class="text-xs font-semibold ${rewardDetailClass}">(${rewardDetail})</span>
                                                </label>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            renderRewards() {
                const container = document.getElementById('redeem-list');
                const balance = this.state.earnedTime - this.state.spentTime;
                container.innerHTML = this.rewards.map(reward => `
                    <button data-cost="${reward.cost}" class="w-full text-left p-4 rounded-lg flex justify-between items-center transition-colors ${balance >= reward.cost ? 'bg-blue-500 hover:bg-blue-600 text-white' : 'bg-slate-200 dark:bg-slate-600 text-slate-500 dark:text-slate-400 cursor-not-allowed'}">
                        <span class="font-bold">${reward.name}</span>
                        <span class="font-semibold">${reward.cost} min</span>
                    </button>
                `).join('');
            },
            
            // ADDED: Render Reward History
            renderRewardHistory() {
                const historyContainer = document.getElementById('reward-history');
                if (!historyContainer) return;

                if (this.state.rewardHistory.length === 0) {
                     historyContainer.innerHTML = '<li class="text-slate-500 italic">No rewards redeemed yet today.</li>';
                } else {
                    historyContainer.innerHTML = this.state.rewardHistory.slice().reverse().map(log => `
                        <li class="flex justify-between items-center py-0.5">
                            <span class="font-medium text-green-600 dark:text-green-400">${log.name}</span>
                            <span class="text-xs font-mono text-slate-600 dark:text-slate-500">${log.timestamp} - ${log.cost} min</span>
                        </li>
                    `).join('');
                }
            },

            renderBadges() {
                const container = document.getElementById('badges-container');
                container.innerHTML = this.badges.map(badgeDef => {
                    const badgeState = this.state.badges.find(b => b.id === badgeDef.id);
                    return `
                        <div class="badge ${badgeState.unlocked ? 'unlocked' : ''}" title="${badgeDef.name}">
                            <div class="text-4xl">${badgeDef.emoji}</div>
                            <div class="text-xs mt-1 font-medium text-slate-900 dark:text-slate-300">${badgeDef.name}</div>
                        </div>
                    `;
                }).join('');
            },
            
            renderThemeToggle() {
                const lightIcon = document.querySelector('.light-icon');
                const darkIcon = document.querySelector('.dark-icon');
                if (this.state.theme === 'light') {
                    lightIcon.classList.remove('hidden');
                    darkIcon.classList.add('hidden');
                } else {
                    lightIcon.classList.add('hidden');
                    darkIcon.classList.remove('hidden');
                }
            },
            
            renderStreakInfo() {
                const streakInfoElement = document.getElementById('streak-info');
                
                // 1. Calculate how many PAST days were perfect (first 6 slots in history)
                let perfectDaysCount = this.state.completionHistory.slice(0, 6).filter(c => c === 1).length;
                
                // 2. Check if TODAY is perfect (live status)
                const isTodayPerfect = this.state.tasks.every(t => t.completed);
                if (isTodayPerfect) {
                    perfectDaysCount += 1;
                }
                
                const totalDays = this.state.completionHistory.length; // 7
                const currentStreak = this.state.streak; 
                
                let message;
                
                if (currentStreak > 0) {
                    // This uses the current streak days directly
                    message = `You are on a **${currentStreak}-day perfect streak**! Keep up the incredible work.`;
                } 
                else if (perfectDaysCount === totalDays) {
                     message = `You've achieved a perfect score every day for the last week! You'll earn a streak bonus tomorrow.`;
                }
                else {
                    // This provides the recent completion rate when the streak is 0
                    message = `Your **recent completion rate** is **${perfectDaysCount} out of ${totalDays} days**. Focus on making today perfect!`;
                }
                
                // Use innerHTML for simple bolding
                message = message.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                
                streakInfoElement.innerHTML = message;
            },

            renderCharts() {
                this.renderMinutesChart();
                this.renderStreakChart();
            },
            
            renderMinutesChart() {
                const ctx = document.getElementById('earnedMinutesChart').getContext('2d');
                const earnedData = this.missions.map(mission => {
                    return mission.tasks.reduce((total, taskDef) => {
                        const taskState = this.state.tasks.find(t => t.id === taskDef.id);
                        return total + (taskState.completed ? taskDef.time : 0);
                    }, 0);
                });
                
                const hasData = earnedData.some(d => d > 0);
                
                // ADDED: Handle Empty State Visibility
                document.getElementById('minutes-chart-empty').classList.toggle('hidden', hasData);

                const chartData = {
                    labels: this.missions.map(m => m.name),
                    datasets: [{
                        data: hasData ? earnedData : [1], // If no data, render a single neutral slice
                        backgroundColor: hasData 
                            ? ['#34d399', '#60a5fa', '#facc15', '#fb923c', '#8b5cf6', '#ef4444'] 
                            : ['#e2e8f0'],
                        borderColor: this.state.theme === 'light' ? 'var(--card-light)' : 'var(--card-dark)',
                        borderWidth: 4,
                        hoverOffset: 8
                    }]
                };

                const chartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { display: hasData, position: 'bottom', labels: { color: this.state.theme === 'dark' ? 'white' : 'black' } },
                        tooltip: {
                            enabled: hasData, // Disable tooltips if empty
                            callbacks: {
                                label: function(context) { return `${context.label}: ${context.raw} min`; }
                            }
                        }
                    }
                };
                
                if (this.minutesChartInstance) {
                    this.minutesChartInstance.destroy();
                }
                this.minutesChartInstance = new Chart(ctx, { type: 'doughnut', data: chartData, options: chartOptions });
            },
            
            renderStreakChart() {
                const ctx = document.getElementById('streakHistoryChart').getContext('2d');
                const days = ['Day -6', 'Day -5', 'Day -4', 'Day -3', 'Day -2', 'Yesterday', 'Today'];
                // To reflect today's status in the chart without waiting for reset, we use a temporary data array
                const data = [...this.state.completionHistory.slice(0, 6), this.state.tasks.every(t => t.completed) ? 1 : 0];
                const lineColor = this.state.theme === 'dark' ? '#3b82f6' : '#2563eb';
                const gridColor = this.state.theme === 'dark' ? '#334155' : '#e2e8f0';
                const tickColor = this.state.theme === 'dark' ? 'white' : 'black';

                const chartData = {
                    labels: days,
                    datasets: [{
                        label: 'Completion Status',
                        data: data,
                        borderColor: lineColor,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        pointBackgroundColor: lineColor,
                        pointBorderColor: 'white',
                        pointHoverRadius: 6,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 4,
                    }]
                };

                const chartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: -0.1, 
                            max: 1.1,
                            ticks: { 
                                stepSize: 1, 
                                callback: function(value) { return value === 1 ? 'Perfect' : 'Incomplete'; },
                                color: tickColor,
                            },
                            grid: { color: gridColor },
                            title: { display: false }
                        },
                        x: {
                            grid: { color: gridColor },
                            ticks: { color: tickColor }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) { return context.raw === 1 ? 'Perfect Day Achieved' : 'Day Incomplete'; }
                            }
                        }
                    }
                };

                if (this.streakChartInstance) {
                    this.streakChartInstance.destroy();
                }
                this.streakChartInstance = new Chart(ctx, { type: 'line', data: chartData, options: chartOptions });
            }
        };

        app.init();
    });
    </script>
</body>
</html>
